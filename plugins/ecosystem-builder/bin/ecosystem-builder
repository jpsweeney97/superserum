#!/usr/bin/env python3
"""
Ecosystem Builder CLI

Autonomous workflow that expands the skill ecosystem by finding gaps,
building artifacts, and staging for review.

Usage:
    ecosystem-builder run --artifacts 5
    ecosystem-builder status
    ecosystem-builder review
"""
# /// script
# requires-python = ">=3.12"
# dependencies = ["click>=8.0"]
# ///

import sys
from pathlib import Path

# Add lib to path
sys.path.insert(0, str(Path(__file__).parent.parent))

import click

from lib.state import StateManager


@click.group()
@click.version_option(version="0.1.0")
def cli() -> None:
    """Ecosystem Builder - autonomous skill ecosystem expansion."""
    pass


@cli.command()
@click.option("--artifacts", "-n", type=int, required=True, help="Number of artifacts to build")
@click.option("--hours", type=float, default=4.0, help="Maximum hours to run")
@click.option("--cost", type=float, default=50.0, help="Maximum cost in USD")
@click.option("--dry-run", is_flag=True, help="Create run without executing")
def run(artifacts: int, hours: float, cost: float, dry_run: bool) -> None:
    """Start a new ecosystem-builder run."""
    from lib.orchestrator import Orchestrator

    manager = StateManager()
    manifest = manager.create_run(
        artifact_limit=artifacts,
        hour_limit=hours,
        cost_limit=cost,
    )

    click.echo(f"Created run: {manifest.run_id}")
    click.echo(f"  Artifacts: 0/{artifacts}")
    click.echo(f"  Hours: 0.0/{hours}")
    click.echo(f"  Cost: $0.00/${cost:.2f}")
    click.echo()

    if dry_run:
        click.echo("Dry run - not executing. Use 'ecosystem-builder status' to check.")
        return

    click.echo("Starting orchestrator...")
    orchestrator = Orchestrator(manifest=manifest)
    orchestrator.run()

    click.echo()
    click.echo(f"Run complete: {manifest.completion_reason}")
    click.echo(f"  Built: {manifest.progress.built}")
    click.echo(f"  Passed: {manifest.progress.passed}")
    click.echo(f"  Failed: {manifest.progress.failed}")


@cli.command()
def status() -> None:
    """Show status of current or recent runs."""
    manager = StateManager()
    manifest = manager.load_current()

    if manifest is None:
        click.echo("No active run. Use 'ecosystem-builder run' to start one.")
        return

    click.echo(f"Run: {manifest.run_id}")
    click.echo(f"Status: {manifest.status}")
    click.echo(f"Started: {manifest.started}")
    click.echo()
    click.echo("Budget:")
    click.echo(f"  Artifacts: {manifest.budget.artifacts.used}/{manifest.budget.artifacts.limit}")
    click.echo(f"  Hours: {manifest.budget.hours.used:.1f}/{manifest.budget.hours.limit:.1f}")
    click.echo(f"  Cost: ${manifest.budget.cost_usd.used:.2f}/${manifest.budget.cost_usd.limit:.2f}")
    click.echo()
    click.echo("Progress:")
    click.echo(f"  Analyzed: {manifest.progress.analyzed}")
    click.echo(f"  Built: {manifest.progress.built}")
    click.echo(f"  Passed: {manifest.progress.passed}")
    click.echo(f"  Failed: {manifest.progress.failed}")


@cli.command()
@click.option("--all", "show_all", is_flag=True, help="Show all staged artifacts")
@click.option("--accept", type=str, help="Accept artifact by name")
@click.option("--reject", type=str, help="Reject artifact by name")
@click.option("--reason", type=str, default="", help="Rejection reason")
def review(show_all: bool, accept: str, reject: str, reason: str) -> None:
    """Review staged artifacts."""
    from lib.staging import StagingManager

    staging = StagingManager()
    artifacts = staging.list_staged()

    if accept:
        try:
            prod_path = staging.accept(accept)
            click.echo(f"✓ Accepted '{accept}' → {prod_path}")
        except FileNotFoundError:
            click.echo(f"✗ Artifact not found: {accept}", err=True)
            raise SystemExit(1)
        return

    if reject:
        try:
            rejected_path = staging.reject(reject, reason=reason)
            click.echo(f"✗ Rejected '{reject}' → {rejected_path}")
        except FileNotFoundError:
            click.echo(f"✗ Artifact not found: {reject}", err=True)
            raise SystemExit(1)
        return

    # List staged artifacts
    if not artifacts:
        click.echo("No staged artifacts.")
        click.echo("Run 'ecosystem-builder run --artifacts N' to generate skills.")
        return

    click.echo(f"Staged artifacts ({len(artifacts)}):\n")

    for artifact in artifacts:
        click.echo(f"  {artifact.name}")
        click.echo(f"    Type: {artifact.artifact_type}")
        click.echo(f"    Run: {artifact.run_id}")
        click.echo(f"    Gap: {artifact.gap_id}")
        click.echo(f"    Staged: {artifact.staged_at[:19]}")

        # Show preview if --all
        if show_all:
            skill_file = artifact.path / "SKILL.md"
            if skill_file.exists():
                preview = skill_file.read_text()[:200]
                click.echo(f"    Preview: {preview}...")
        click.echo()

    click.echo("Commands:")
    click.echo("  ecosystem-builder review --accept NAME")
    click.echo("  ecosystem-builder review --reject NAME --reason 'Why'")


if __name__ == "__main__":
    cli()
